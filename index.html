<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <title>Sistema de Estoque Completo</title>
  <!-- Bootstrap CSS -->
  <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <!-- jsPDF e autoTable -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>
  <!-- JsBarcode -->
  <script src="https://cdn.jsdelivr.net/npm/jsbarcode@3.11.5/dist/JsBarcode.all.min.js"></script>
  <!-- SortableJS -->
  <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.10.2/Sortable.min.js"></script>
  <!-- EmailJS SDK -->
  <script type="text/javascript" src="https://cdn.emailjs.com/sdk/2.3.2/email.min.js"></script>
  <script type="text/javascript">
      (function(){
         // Inicializa com a sua Public Key fornecida
         emailjs.init("solFrTsgTIaarSHsW");
      })();
  </script>
  
  <!-- Estilos customizados (Preto & Laranja) -->
  <style>
    body {
      background-color: #fdfdfd; 
      padding-top: 56px;
      font-family: "Roboto", Arial, sans-serif;
    }
    .navbar {
      background-color: #000 !important;
    }
    .navbar-brand, .navbar-nav .nav-link {
      color: #FFA500 !important;
    }
    .navbar-brand:hover, .navbar-nav .nav-link:hover {
      color: #ffbb33 !important;
    }
    .section-title {
      border-bottom: 2px solid #FFA500;
      margin-bottom: 15px;
      padding-bottom: 5px;
      font-weight: 600;
      color: #000;
    }
    .card {
      margin-bottom: 20px;
      border-radius: 0.5rem;
      border: 1px solid #FFA500;
    }
    .card .card-body {
      padding: 1.5rem;
    }
    .table thead th {
      background-color: #FFA500 !important; 
      color: #000 !important;
      text-transform: uppercase;
      font-size: 0.9rem;
      border-color: #000 !important;
    }
    .table td, .table th {
      vertical-align: middle;
      border-color: #FFA500 !important;
    }
    .btn-orange {
      background-color: #FFA500;
      color: #000;
      border-radius: 20px;
      border: 1px solid #000;
    }
    .btn-orange:hover {
      background-color: #ffbb33;
      color: #000;
    }
    .btn-black {
      background-color: #000;
      color: #FFA500;
      border-radius: 20px;
      border: 1px solid #FFA500;
    }
    .btn-black:hover {
      background-color: #333;
      color: #FFA500;
    }
    .alerta {
      background-color: #fff3cd !important;
    }
    #toastContainer {
      position: fixed;
      top: 70px;
      right: 20px;
      z-index: 9999;
    }
    .toast {
      min-width: 250px;
      border-radius: 10px;
    }
    #historicoMovimentacoes {
      display: none;
    }
    .chart-container {
      width: 100%;
      max-width: 700px;
      height: 400px;
      margin: 0 auto;
    }
  </style>
</head>
<body>
  <!-- Navbar -->
  <nav class="navbar navbar-expand-lg fixed-top">
    <a class="navbar-brand" href="#">Sistema de Estoque</a>
    <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarEstoque" aria-controls="navbarEstoque" aria-expanded="false" aria-label="Toggle navigation" style="border-color: #FFA500;">
      <span class="navbar-toggler-icon" style="background-image: url('data:image/svg+xml;charset=UTF8,%3Csvg viewBox%3D%220 0 30 30%22 xmlns%3D%22http://www.w3.org/2000/svg%22%3E%3Cpath stroke%3D%22%23FFA500%22 stroke-width%3D%222%22 stroke-linecap%3D%22round%22 stroke-miterlimit%3D%2210%22 d%3D%22M4 7h22M4 15h22M4 23h22%22/%3E%3C/svg%3E');"></span>
    </button>
    <div class="collapse navbar-collapse" id="navbarEstoque">
      <ul class="navbar-nav mr-auto">
        <li class="nav-item">
          <a class="nav-link" id="controle-tab" data-toggle="tab" href="#controle" role="tab" aria-controls="controle">Controle de Estoque</a>
        </li>
        <li class="nav-item">
          <a class="nav-link" id="administracao-tab" data-toggle="tab" href="#administracao" role="tab" aria-controls="administracao">Administração</a>
        </li>
        <li class="nav-item">
          <a class="nav-link" id="relatorios-tab" data-toggle="tab" href="#relatorios" role="tab" aria-controls="relatorios">Relatórios</a>
        </li>
      </ul>
    </div>
  </nav>

  <!-- Container de Toasts -->
  <div id="toastContainer"></div>

  <div class="container my-4">
    <div class="tab-content" id="tabsContent">
      <!-- Controle de Estoque -->
      <div class="tab-pane fade show active pt-3" id="controle" role="tabpanel" aria-labelledby="controle-tab">
        <div class="card">
          <div class="card-body">
            <div id="alertaBaixoEstoque" class="alert alert-warning d-none">
              <strong>Atenção!</strong> Os seguintes produtos estão com estoque baixo: <span id="listaBaixoEstoque"></span>
            </div>
            <h2 class="section-title">Estoque Atual</h2>
            <div class="table-responsive">
              <table class="table table-bordered table-hover">
                <thead>
                  <tr>
                    <th>Produto</th>
                    <th>Fabricante</th>
                    <th>Quantidade</th>
                    <th>Tamanho da Embalagem</th>
                    <th>Embalagens</th>
                  </tr>
                </thead>
                <tbody id="tabelaEstoqueBody">
                  <!-- Gerado dinamicamente -->
                </tbody>
              </table>
            </div>
          </div>
        </div>
        <!-- Retirada via Leitor -->
        <div class="card">
          <div class="card-body">
            <h2 class="section-title">Retirada de Produto</h2>
            <p>Utilize o leitor de código de barras para realizar a retirada. Basta passar o código no campo abaixo e pressionar Enter.</p>
            <div class="form-group">
              <label for="barcodeRetirada">Código de Barras:</label>
              <input type="text" class="form-control" id="barcodeRetirada" placeholder="Passe o código" autofocus onkeypress="if(event.key === 'Enter') { efetuarRetirada(); }">
            </div>
          </div>
        </div>
      </div>
      
      <!-- Administração -->
      <div class="tab-pane fade pt-3" id="administracao" role="tabpanel" aria-labelledby="administracao-tab">
        <div id="adminContent"></div>
      </div>
      
      <!-- Relatórios -->
      <div class="tab-pane fade pt-3" id="relatorios" role="tabpanel" aria-labelledby="relatorios-tab">
        <div class="card">
          <div class="card-body">
            <h2 class="section-title">Gráfico de Estoque</h2>
            <div class="chart-container">
              <canvas id="estoqueChart"></canvas>
            </div>
            <div class="mt-3">
              <button class="btn btn-orange" onclick="gerarRelatorio()">Atualizar Relatório</button>
              <button class="btn btn-black" onclick="gerarPDFRelatorio()">Gerar PDF Estoque Baixo</button>
              <button class="btn btn-orange" onclick="gerarPDFCompletoComBarCode()">Gerar PDF Completo com Cód. de Barras</button>
              <button class="btn btn-black" onclick="gerarPDFCompletoEstoque()">Gerar PDF Completo (Estoque)</button>
              <!-- Botão para enviar relatório por e-mail -->
              <button class="btn btn-orange" onclick="enviarRelatorioEmail()">Enviar Relatório por E-mail</button>
              <!-- Botão para gerar formulário de retirada manual -->
              <button class="btn btn-black" onclick="gerarFormularioRetirada()">Gerar Formulário de Retirada Manual</button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Scripts do Bootstrap -->
  <script src="https://code.jquery.com/jquery-3.5.1.slim.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.1/dist/umd/popper.min.js"></script>
  <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
  
  <script>
    /*********** Persistência e Dados ***********/
    let produtos = JSON.parse(localStorage.getItem("produtos")) || [];
    let logMovimentacoes = JSON.parse(localStorage.getItem("logMovimentacoes")) || [];
    
    function salvarDados() {
      localStorage.setItem("produtos", JSON.stringify(produtos));
      localStorage.setItem("logMovimentacoes", JSON.stringify(logMovimentacoes));
    }
    
    /*********** Exibir Toast ***********/
    function exibirToast(mensagem, tipo = "success") {
      const toast = document.createElement("div");
      toast.classList.add("toast", `bg-${tipo}`, "text-white");
      toast.setAttribute("role", "alert");
      toast.setAttribute("aria-live", "assertive");
      toast.setAttribute("aria-atomic", "true");
      toast.style.opacity = "0.9";
      toast.innerHTML = `<div class="toast-body">${mensagem}</div>`;
      document.getElementById("toastContainer").appendChild(toast);
      $(toast).toast({ delay: 3000 });
      $(toast).toast("show");
      toast.addEventListener("hidden.bs.toast", () => { toast.remove(); });
    }
    
    /*********** Controle de Estoque (Visão Pública) ***********/
    function atualizarTabela() {
      const tbody = document.getElementById("tabelaEstoqueBody");
      tbody.innerHTML = "";
      let listaBaixoEstoque = [];
      const LIMITE_AVISO = 10;
      // Ordena produtos pela ordem definida
      produtos.sort((a, b) => (a.ordem || 0) - (b.ordem || 0));
      produtos.forEach(produto => {
        let classeAlerta = (produto.quantidade <= LIMITE_AVISO) ? "alerta" : "";
        if (produto.quantidade <= LIMITE_AVISO) { 
          listaBaixoEstoque.push(produto.nome);
        }
        const embalagens = produto.tamanhoEmbalagem ? Math.floor(produto.quantidade / produto.tamanhoEmbalagem) : "-";
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td class="${classeAlerta}">${produto.nome}</td>
          <td class="${classeAlerta}">${produto.fabricante || "-"}</td>
          <td class="${classeAlerta}">${produto.quantidade}</td>
          <td class="${classeAlerta}">${produto.tamanhoEmbalagem || produto.tamanho || "-"}</td>
          <td class="${classeAlerta}">${embalagens}</td>
        `;
        tbody.appendChild(tr);
      });
      const alertaDiv = document.getElementById("alertaBaixoEstoque");
      const listaSpan = document.getElementById("listaBaixoEstoque");
      if (listaBaixoEstoque.length > 0) {
        listaSpan.textContent = listaBaixoEstoque.join(", ");
        alertaDiv.classList.remove("d-none");
      } else {
        alertaDiv.classList.add("d-none");
      }
      salvarDados();
    }
    
    // Retirada via Leitor Físico
    function efetuarRetirada() {
      const codigo = document.getElementById("barcodeRetirada").value.trim();
      if (!codigo) { exibirToast("Passe o código no leitor!", "danger"); return; }
      let index = produtos.findIndex(p => p.barcode === codigo);
      if (index !== -1) {
        const produto = produtos[index];
        const embalagem = produto.tamanhoEmbalagem || produto.tamanho || 1;
        if (produto.quantidade >= embalagem) {
          const quantidadeAnterior = produto.quantidade;
          produto.quantidade -= embalagem;
          atualizarTabela();
          addLog("Retirada", `Retirada via leitor: 1 embalagem (${embalagem} unidades) do produto "${produto.nome}".`, {
            barcode: produto.barcode,
            nome: produto.nome,
            quantidadeAnterior,
            quantidadeNova: produto.quantidade
          });
          exibirToast(`Retirada realizada para "${produto.nome}".`);
        } else {
          exibirToast("Estoque insuficiente para retirar uma embalagem completa!", "danger");
        }
      } else {
        if (confirm("Produto não encontrado. Deseja pesquisar no Google?")) {
          window.open(`https://www.google.com/search?q=${encodeURIComponent(codigo)}`, '_blank');
        }
      }
      document.getElementById("barcodeRetirada").value = "";
      manterFocoScanner();
    }
    
    /*********** Log de Movimentações ***********/
    function addLog(operacao, detalhes, delta = null) {
      const data = new Date().toLocaleString();
      logMovimentacoes.push({ data, operacao, detalhes, delta });
      atualizarLog();
    }
    
    function toggleHistorico() {
      const hist = document.getElementById("historicoMovimentacoes");
      hist.style.display = (hist.style.display === "none") ? "block" : "none";
    }
    
    function atualizarLog() {
      const divHistorico = document.getElementById("historicoMovimentacoes");
      if (!divHistorico) return;
      let grupos = {};
      logMovimentacoes.forEach(log => {
        const dia = log.data.split(" ")[0];
        if (!grupos[dia]) grupos[dia] = [];
        grupos[dia].push(log);
      });
      divHistorico.innerHTML = "";
      Object.keys(grupos).sort().reverse().forEach(dia => {
        const card = document.createElement("div");
        card.classList.add("card", "mb-3");
        const cardBody = document.createElement("div");
        cardBody.classList.add("card-body");
        const titulo = document.createElement("h5");
        titulo.textContent = `Movimentações de ${dia}`;
        cardBody.appendChild(titulo);
        const table = document.createElement("table");
        table.classList.add("table", "table-sm", "table-striped");
        table.innerHTML = `
          <thead>
            <tr>
              <th>Data/Hora</th>
              <th>Operação</th>
              <th>Detalhes</th>
              <th>Reverter</th>
            </tr>
          </thead>
          <tbody></tbody>
        `;
        const tbody = table.querySelector("tbody");
        grupos[dia].slice().reverse().forEach(log => {
          const tr = document.createElement("tr");
          tr.innerHTML = `
            <td>${log.data}</td>
            <td>${log.operacao}</td>
            <td>${log.detalhes}</td>
            <td><button class="btn btn-sm btn-warning" onclick="reverterMovimentacao(${logMovimentacoes.indexOf(log)})">Reverter</button></td>
          `;
          tbody.appendChild(tr);
        });
        cardBody.appendChild(table);
        card.appendChild(cardBody);
        divHistorico.appendChild(card);
      });
      salvarDados();
    }
    
    function reverterMovimentacao(indexLog) {
      if (indexLog < 0) return;
      const logItem = logMovimentacoes[indexLog];
      if (!logItem.delta) {
        exibirToast("Não é possível reverter esta movimentação.", "danger");
        return;
      }
      const delta = logItem.delta;
      let idxProduto = produtos.findIndex(p => p.barcode === delta.barcode);
      if (idxProduto === -1) {
        exibirToast("Produto não encontrado para reverter.", "danger");
        return;
      }
      const produto = produtos[idxProduto];
      produto.quantidade = delta.quantidadeAnterior;
      logMovimentacoes.splice(indexLog, 1);
      exibirToast(`Movimentação revertida para "${produto.nome}".`, "info");
      atualizarTabela();
      atualizarLog();
      salvarDados();
    }
    
    /*********** Área de Administração ***********/
    function renderAdminContent() {
      const adminDiv = document.getElementById("adminContent");
      if (localStorage.getItem("loggedIn") === "true") {
        adminDiv.innerHTML = `
          <div class="card mb-3">
            <div class="card-body">
              <h2 class="section-title">Cadastro / Atualização de Produto</h2>
              <form id="formProduto" class="mb-4">
                <div class="form-group">
                  <label for="barcode">Código de Barras:</label>
                  <input type="text" class="form-control" id="barcode" placeholder="Digite ou passe o código" required>
                </div>
                <div class="form-group">
                  <label for="nomeProduto">Nome do Produto:</label>
                  <input type="text" class="form-control" id="nomeProduto" required>
                </div>
                <div class="form-group">
                  <label for="fabricante">Fabricante:</label>
                  <input type="text" class="form-control" id="fabricante">
                </div>
                <div class="form-group">
                  <label for="quantidadeProduto">Quantidade Total:</label>
                  <input type="number" class="form-control" id="quantidadeProduto" required>
                </div>
                <div class="form-group">
                  <label for="tamanhoEmbalagem">Tamanho da Embalagem:</label>
                  <input type="number" class="form-control" id="tamanhoEmbalagem" required>
                </div>
                <button type="submit" class="btn btn-orange">Salvar Produto</button>
              </form>
            </div>
          </div>
          <!-- Cadastro em Lote CSV -->
          <div class="card mb-3">
            <div class="card-body">
              <h2 class="section-title">Cadastro em Lote (CSV)</h2>
              <p>Selecione um arquivo CSV com as colunas: <code>barcode, nome, fabricante, quantidade, tamanhoEmbalagem</code>.</p>
              <div class="mb-3">
                <button class="btn btn-black" onclick="baixarExemploCSV()">Baixar Exemplo CSV</button>
              </div>
              <input type="file" id="arquivoCSV" accept=".csv" class="form-control mb-3">
              <button class="btn btn-orange" onclick="importarCSV()">Importar CSV</button>
            </div>
          </div>
          <!-- Produtos Cadastrados com Drag & Drop -->
          <div class="card mb-3">
            <div class="card-body">
              <h2 class="section-title">Produtos Cadastrados (Admin)</h2>
              <div class="table-responsive">
                <table class="table table-bordered table-hover">
                  <thead>
                    <tr>
                      <th>Produto</th>
                      <th>Fabricante</th>
                      <th>Quantidade</th>
                      <th>Tamanho da Embalagem</th>
                      <th>Embalagens</th>
                      <th>Ações</th>
                    </tr>
                  </thead>
                  <tbody id="tabelaAdminBody"></tbody>
                </table>
              </div>
              <h2 class="section-title">Histórico de Movimentações</h2>
              <button class="btn btn-sm btn-orange mb-2" onclick="toggleHistorico()">Mostrar/Esconder Histórico</button>
              <div id="historicoMovimentacoes"></div>
              <!-- Botão para enviar e-mail com relatório -->
              <button class="btn btn-orange mt-3" onclick="enviarRelatorioEmail()">Enviar Relatório por E-mail</button>
            </div>
          </div>
          <!-- Backup de Dados -->
          <div class="card">
            <div class="card-body">
              <h2 class="section-title">Backup de Dados</h2>
              <p>Exporte ou importe os dados do sistema (produtos e movimentações).</p>
              <button class="btn btn-orange mb-3" onclick="exportarBackup()">Exportar Backup</button>
              <input type="file" id="arquivoBackup" accept=".json" class="form-control mb-2">
              <button class="btn btn-black" onclick="importarBackup()">Importar Backup</button>
              <button class="btn btn-secondary float-right mt-3" onclick="logoutAdmin()">Sair</button>
            </div>
          </div>
        `;
        document.getElementById("formProduto").addEventListener("submit", function(event) {
          event.preventDefault();
          const barcode = document.getElementById("barcode").value.trim();
          const nome = document.getElementById("nomeProduto").value.trim();
          const fabricante = document.getElementById("fabricante").value.trim();
          const quantidade = parseInt(document.getElementById("quantidadeProduto").value);
          const tamanhoEmbalagem = parseInt(document.getElementById("tamanhoEmbalagem").value);
          let index = produtos.findIndex(p => p.barcode === barcode || p.nome.toLowerCase() === nome.toLowerCase());
          const quantidadeAnterior = (index !== -1) ? produtos[index].quantidade : 0;
          if (index !== -1) {
            produtos[index] = {
              ...produtos[index],
              nome,
              fabricante,
              quantidade,
              tamanhoEmbalagem,
              quantidadeOriginal: quantidade,
              barcode
            };
            addLog("Atualização", `Produto "${nome}" atualizado.`, {
              barcode,
              nome,
              quantidadeAnterior,
              quantidadeNova: quantidade
            });
            exibirToast(`Produto "${nome}" atualizado.`);
          } else {
            produtos.push({
              nome,
              fabricante,
              quantidade,
              tamanhoEmbalagem,
              quantidadeOriginal: quantidade,
              barcode,
              ordem: produtos.length
            });
            addLog("Cadastro", `Produto "${nome}" cadastrado.`, {
              barcode,
              nome,
              quantidadeAnterior: 0,
              quantidadeNova: quantidade
            });
            exibirToast(`Produto "${nome}" cadastrado.`);
          }
          atualizarTabela();
          renderAdminTabela();
          salvarDados();
          document.getElementById("formProduto").reset();
        });
        
        renderAdminTabela();
        atualizarLog();
      } else {
        adminDiv.innerHTML = `
          <div class="card">
            <div class="card-body">
              <h2 class="section-title">Login para Administração</h2>
              <form id="loginFormAdmin">
                <div class="form-group">
                  <label for="loginUser">Usuário:</label>
                  <input type="text" class="form-control" id="loginUser" placeholder="Digite o usuário" required>
                </div>
                <div class="form-group">
                  <label for="loginPass">Senha:</label>
                  <input type="password" class="form-control" id="loginPass" placeholder="Digite a senha" required>
                </div>
                <button type="submit" class="btn btn-orange btn-block">Entrar</button>
              </form>
            </div>
          </div>
        `;
        document.getElementById("loginFormAdmin").addEventListener("submit", function(event) {
          event.preventDefault();
          const user = document.getElementById("loginUser").value.trim();
          const pass = document.getElementById("loginPass").value.trim();
          if (user === "admin" && pass === "1234") {
            localStorage.setItem("loggedIn", "true");
            renderAdminContent();
            exibirToast("Login realizado com sucesso!");
          } else {
            exibirToast("Usuário ou senha inválidos!", "danger");
          }
        });
      }
    }
    
    // Renderização da tabela de administração com Drag & Drop
    function renderAdminTabela() {
      const tbody = document.getElementById("tabelaAdminBody");
      if (!tbody) return;
      produtos.sort((a, b) => (a.ordem || 0) - (b.ordem || 0));
      tbody.innerHTML = "";
      produtos.forEach((produto, index) => {
        const tr = document.createElement("tr");
        tr.setAttribute("data-index", index);
        const embalagens = produto.tamanhoEmbalagem ? Math.floor(produto.quantidade / produto.tamanhoEmbalagem) : "-";
        tr.innerHTML = `
          <td>${produto.nome}</td>
          <td>${produto.fabricante || "-"}</td>
          <td>${produto.quantidade}</td>
          <td>${produto.tamanhoEmbalagem || produto.tamanho || "-"}</td>
          <td>${embalagens}</td>
          <td>
            <button class="btn btn-sm btn-orange" onclick="editarProduto(${index})">Editar</button>
            <button class="btn btn-sm btn-black" onclick="excluirProduto(${index})">Excluir</button>
          </td>
        `;
        tbody.appendChild(tr);
      });
      Sortable.create(tbody, {
        animation: 150,
        onEnd: function(evt) {
          const newOrder = [];
          tbody.querySelectorAll("tr").forEach((tr, newIndex) => {
            const oldIndex = parseInt(tr.getAttribute("data-index"));
            produtos[oldIndex].ordem = newIndex;
            newOrder.push(produtos[oldIndex]);
          });
          produtos = newOrder;
          salvarDados();
          renderAdminTabela();
          atualizarTabela();
          exibirToast("Ordem atualizada!", "success");
        }
      });
    }
    
    function editarProduto(index) {
      const produto = produtos[index];
      document.getElementById("barcode").value = produto.barcode;
      document.getElementById("nomeProduto").value = produto.nome;
      document.getElementById("fabricante").value = produto.fabricante;
      document.getElementById("quantidadeProduto").value = produto.quantidade;
      document.getElementById("tamanhoEmbalagem").value = produto.tamanhoEmbalagem || produto.tamanho;
    }
    
    function excluirProduto(index) {
      if (confirm("Tem certeza que deseja excluir este produto?")) {
        const nome = produtos[index].nome;
        const barcode = produtos[index].barcode;
        const quantidadeAnterior = produtos[index].quantidade;
        produtos.splice(index, 1);
        renderAdminTabela();
        atualizarTabela();
        addLog("Exclusão", `Produto "${nome}" foi excluído.`, {
          barcode,
          nome,
          quantidadeAnterior,
          quantidadeNova: 0
        });
        exibirToast(`Produto "${nome}" foi excluído.`, "danger");
      }
    }
    
    function logoutAdmin() {
      localStorage.removeItem("loggedIn");
      renderAdminContent();
      exibirToast("Você saiu do modo administrador.", "info");
    }
    
    /*********** Importar CSV ***********/
    function importarCSV() {
      const inputFile = document.getElementById("arquivoCSV");
      if (!inputFile.files.length) {
        exibirToast("Selecione um arquivo CSV primeiro!", "warning");
        return;
      }
      const file = inputFile.files[0];
      const reader = new FileReader();
      reader.onload = function(e) {
        const texto = e.target.result;
        const linhas = texto.split("\n").map(l => l.trim()).filter(l => l);
        linhas.forEach((linha, idx) => {
          if (idx === 0 && linha.toLowerCase().includes("barcode")) return;
          const colunas = linha.split(",");
          if (colunas.length < 5) return;
          const [barcode, nome, fabricante, quantidade, tamanhoEmbalagem] = colunas.map(c => c.trim());
          const qtd = parseInt(quantidade, 10) || 0;
          const tam = parseInt(tamanhoEmbalagem, 10) || 1;
          let index = produtos.findIndex(p => p.barcode === barcode || p.nome.toLowerCase() === nome.toLowerCase());
          if (index !== -1) {
            const qtdAnterior = produtos[index].quantidade;
            produtos[index] = {
              ...produtos[index],
              nome,
              fabricante,
              quantidade: qtd,
              tamanhoEmbalagem: tam,
              quantidadeOriginal: qtd,
              barcode
            };
            addLog("Atualização (CSV)", `Produto "${nome}" atualizado via CSV.`, {
              barcode,
              nome,
              quantidadeAnterior: qtdAnterior,
              quantidadeNova: qtd
            });
          } else {
            produtos.push({
              nome,
              fabricante,
              quantidade: qtd,
              tamanhoEmbalagem: tam,
              quantidadeOriginal: qtd,
              barcode,
              ordem: produtos.length
            });
            addLog("Cadastro (CSV)", `Produto "${nome}" cadastrado via CSV.`, {
              barcode,
              nome,
              quantidadeAnterior: 0,
              quantidadeNova: qtd
            });
          }
        });
        exibirToast("Importação concluída!", "success");
        atualizarTabela();
        renderAdminTabela();
        salvarDados();
        inputFile.value = "";
      };
      reader.readAsText(file);
    }
    
    function baixarExemploCSV() {
      let csv = "barcode,nome,fabricante,quantidade,tamanhoEmbalagem\n";
      csv += "123456,Produto Exemplo,FabX,50,5\n";
      csv += "999999,Outro Produto,FabY,10,2\n";
      csv += "543210,Produto 3,FabZ,100,1\n";
      const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
      const link = document.createElement("a");
      const url = URL.createObjectURL(blob);
      link.setAttribute("href", url);
      link.setAttribute("download", "ExemploCadastro.csv");
      link.style.visibility = 'hidden';
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
    }
    
    /*********** Backup de Dados (JSON) ***********/
    function exportarBackup() {
      const backup = { produtos, logMovimentacoes };
      const jsonString = JSON.stringify(backup, null, 2);
      const blob = new Blob([jsonString], { type: 'application/json' });
      const link = document.createElement("a");
      const url = URL.createObjectURL(blob);
      link.setAttribute("href", url);
      link.setAttribute("download", "BackupEstoque.json");
      link.style.visibility = 'hidden';
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
      exibirToast("Backup exportado com sucesso!", "success");
    }
    
    function importarBackup() {
      const inputFile = document.getElementById("arquivoBackup");
      if (!inputFile.files.length) {
        exibirToast("Selecione um arquivo de backup (.json) primeiro!", "warning");
        return;
      }
      const file = inputFile.files[0];
      const reader = new FileReader();
      reader.onload = function(e) {
        try {
          const conteudo = JSON.parse(e.target.result);
          if (!conteudo.produtos || !conteudo.logMovimentacoes) {
            exibirToast("Arquivo de backup inválido!", "danger");
            return;
          }
          produtos = conteudo.produtos;
          logMovimentacoes = conteudo.logMovimentacoes;
          salvarDados();
          atualizarTabela();
          renderAdminTabela();
          atualizarLog();
          exibirToast("Backup importado com sucesso!", "success");
          inputFile.value = "";
        } catch (error) {
          exibirToast("Erro ao importar backup!", "danger");
        }
      };
      reader.readAsText(file);
    }
    
    /*********** Relatórios (Chart.js e PDF) ***********/
    let estoqueChart;
    function gerarRelatorio() {
      const ctx = document.getElementById('estoqueChart').getContext('2d');
      const labels = produtos.map(p => p.nome);
      const dataValues = produtos.map(p => p.quantidade);
      if (estoqueChart) { estoqueChart.destroy(); }
      estoqueChart = new Chart(ctx, {
        type: 'bar',
        data: {
          labels: labels,
          datasets: [{
            label: 'Quantidade em Estoque',
            data: dataValues,
            backgroundColor: '#FFA500',
            borderColor: '#000',
            borderWidth: 1
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          scales: {
            yAxes: [{
              ticks: { beginAtZero: true, precision: 0 }
            }]
          }
        }
      });
    }
    
    function gerarPDFRelatorio() {
      const LIMITE_AVISO = 10;
      const produtosFaltando = produtos.filter(produto => produto.quantidade <= LIMITE_AVISO);
      if (produtosFaltando.length === 0) {
        exibirToast("Não há produtos com estoque baixo.", "info");
        return;
      }
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF();
      doc.setFontSize(16);
      doc.text("Relatório de Estoque Baixo", 14, 20);
      const tableColumn = ["Produto", "Fabricante", "Quantidade", "Tamanho", "Embalagens"];
      const tableRows = [];
      produtosFaltando.forEach(produto => {
         const embalagens = produto.tamanhoEmbalagem ? Math.floor(produto.quantidade / produto.tamanhoEmbalagem) : "-";
         tableRows.push([
             produto.nome,
             produto.fabricante || "-",
             produto.quantidade.toString(),
             (produto.tamanhoEmbalagem || produto.tamanho || "").toString(),
             embalagens
         ]);
      });
      doc.autoTable({
         head: [tableColumn],
         body: tableRows,
         startY: 30,
         theme: 'grid'
      });
      doc.save("Relatorio_Estoque_Baixo.pdf");
      exibirToast("PDF de estoque baixo gerado com sucesso!", "success");
    }
    
    function gerarPDFCompletoComBarCode() {
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF();
      doc.setFontSize(16);
      doc.text("Relatório Completo de Estoque", 14, 20);
      const tableData = produtos.map(produto => ({
        nome: produto.nome,
        fabricante: produto.fabricante || "-",
        quantidade: produto.quantidade.toString(),
        tamanho: (produto.tamanhoEmbalagem || produto.tamanho || "").toString(),
        barcode: produto.barcode || ""
      }));
      doc.autoTable({
        startY: 30,
        theme: 'grid',
        head: [
          ["Produto", "Fabricante", "Quantidade", "Tamanho", "Código de Barras"]
        ],
        body: tableData.map(item => [
          item.nome,
          item.fabricante,
          item.quantidade,
          item.tamanho,
          item.barcode
        ]),
        columnStyles: {
          4: { cellWidth: 60 }
        },
        didParseCell: function (data) {
          if (data.section === 'body' && data.column.index === 4) {
            data.cell.styles.minCellHeight = 25;
          }
        },
        didDrawCell: function (data) {
          if (
            data.section === 'body' &&
            data.column.index === 4 &&
            data.cell.raw &&
            data.cell.raw !== ""
          ) {
            const barcodeText = data.cell.raw;
            const canvas = document.createElement("canvas");
            JsBarcode(canvas, barcodeText, {
              format: "CODE128",
              width: 1,
              height: 20,
              displayValue: false
            });
            const imgData = canvas.toDataURL("image/png");
            const cellWidth = data.cell.width;
            const cellHeight = data.cell.height;
            const barcodeWidth = 50; 
            const barcodeHeight = 20;
            const xOffset = data.cell.x + (cellWidth - barcodeWidth) / 2;
            const yOffset = data.cell.y + (cellHeight - barcodeHeight) / 2;
            doc.addImage(imgData, "PNG", xOffset, yOffset, barcodeWidth, barcodeHeight);
          }
        }
      });
      doc.save("Estoque_Completo_com_Barcode.pdf");
      exibirToast("PDF completo com códigos de barras gerado com sucesso!", "success");
    }
    
    function gerarPDFCompletoEstoque() {
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF();
      doc.setFontSize(16);
      doc.text("Relatório Completo de Estoque", 14, 20);
      const tableColumn = ["Produto", "Fabricante", "Quantidade", "Tamanho", "Embalagens", "Código de Barras"];
      const tableRows = [];
      produtos.forEach(produto => {
        const embalagens = produto.tamanhoEmbalagem ? Math.floor(produto.quantidade / produto.tamanhoEmbalagem) : "-";
        tableRows.push([
          produto.nome,
          produto.fabricante || "-",
          produto.quantidade.toString(),
          (produto.tamanhoEmbalagem || produto.tamanho || "").toString(),
          embalagens,
          produto.barcode || "-"
        ]);
      });
      doc.autoTable({
        head: [tableColumn],
        body: tableRows,
        startY: 30,
        theme: 'grid'
      });
      doc.save("Relatorio_Completo_Estoque.pdf");
      exibirToast("PDF completo de estoque gerado com sucesso!", "success");
    }
    
    /*********** Função para Gerar Formulário de Retirada Manual ***********/
    function gerarFormularioRetirada() {
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF();
      doc.setFontSize(16);
      doc.text("Formulário de Retirada Manual", 14, 20);
      
      doc.setFontSize(12);
      // Campo Data
      doc.text("Data:", 14, 35);
      doc.line(30, 33, 100, 33);
      
      // Campo Nome do Funcionário
      doc.text("Nome do Funcionário:", 14, 45);
      doc.line(65, 43, 150, 43);
      
      // Campo Código do Produto
      doc.text("Código do Produto:", 14, 55);
      doc.line(65, 53, 150, 53);
      
      // Campo Quantidade Retirada
      doc.text("Quantidade Retirada:", 14, 65);
      doc.line(70, 63, 100, 63);
      
      // Campo Observações
      doc.text("Observações:", 14, 75);
      doc.line(14, 77, 190, 77);
      doc.line(14, 83, 190, 83);
      
      // Rodapé ou instruções
      doc.setFontSize(10);
      doc.text("Preencha os campos manualmente e, posteriormente, insira os dados no sistema.", 14, 95);
      
      doc.save("FormularioRetirada.pdf");
      exibirToast("Formulário de retirada gerado com sucesso!", "success");
    }
    
    /*********** Envio de E-mail com Relatório ***********/
    function enviarRelatorioEmail() {
      let report = "Relatório de Estoque\n\nProdutos:\n";
      produtos.forEach(produto => {
        const embalagens = produto.tamanhoEmbalagem ? Math.floor(produto.quantidade / produto.tamanhoEmbalagem) : "-";
        report += `• ${produto.nome} - Quantidade: ${produto.quantidade} | Tamanho: ${produto.tamanhoEmbalagem || produto.tamanho || "-"} | Embalagens: ${embalagens}\n`;
      });
      const LIMITE_AVISO = 10;
      const lowStock = produtos.filter(produto => produto.quantidade <= LIMITE_AVISO);
      if (lowStock.length > 0) {
        report += "\nProdutos com Estoque Baixo:\n";
        lowStock.forEach(produto => {
          report += `• ${produto.nome} - Quantidade: ${produto.quantidade}\n`;
        });
      }
      const templateParams = {
        to_email: "metalurgica.aguiaglobal@gmail.com",
        to_name: "Metalúrgica Águiá Global",
        subject: "Relatório de Estoque - Sistema de Estoque Completo",
        message: report
      };

      // Utiliza os dados fornecidos:
      // Service ID: service_agyg2lm
      // Template ID: template_zsjzayj
      emailjs.send('service_agyg2lm', 'template_zsjzayj', templateParams)
        .then(function(response) {
          console.log('E-mail enviado com sucesso!', response.status, response.text);
          exibirToast("E-mail enviado com sucesso!", "success");
        }, function(error) {
          console.error('Erro ao enviar e-mail:', error);
          exibirToast("Erro ao enviar e-mail.", "danger");
        });
    }
    
    /*********** Foco no Scanner ***********/
    function manterFocoScanner() {
      const controleTab = document.querySelector('.tab-pane.active');
      if (controleTab && controleTab.id === "controle") {
        document.getElementById("barcodeRetirada").focus();
      }
    }
    document.addEventListener("click", function(e) {
      const activeTab = document.querySelector('.tab-pane.active');
      if (activeTab && activeTab.id === "controle" && e.target.id !== "barcodeRetirada") {
        manterFocoScanner();
      }
    });
    document.getElementById("barcodeRetirada").addEventListener("blur", function() {
      setTimeout(manterFocoScanner, 100);
    });
    
    /*********** Inicialização ***********/
    document.querySelectorAll('.navbar-nav .nav-link').forEach(link => {
      link.addEventListener('click', function(e) {
        e.preventDefault();
        document.querySelectorAll('.nav-link').forEach(item => item.classList.remove('active'));
        document.querySelectorAll('.tab-pane').forEach(tab => tab.classList.remove('show', 'active'));
        this.classList.add('active');
        const target = this.getAttribute('href');
        const tabPane = document.querySelector(target);
        tabPane.classList.add('show', 'active');
        if (target === '#controle') { setTimeout(manterFocoScanner, 200); }
      });
    });
    
    atualizarTabela();
    atualizarLog();
    renderAdminContent();
    window.onload = function() {
      gerarRelatorio();
      manterFocoScanner();
    };
  </script>
</body>
</html>
